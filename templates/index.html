<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç›‘æ§ç®¡ç†é¢æ¿ - å·å·çš„å°å·¥å…·</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#885021',
                        'primary-light': '#a67c52',
                        'el-success': '#67c23a',
                        'el-warning': '#e6a23c',
                        'el-danger': '#f56c6c',
                        'el-info': '#409eff',
                        'text-primary': '#303133',
                        'text-regular': '#606266',
                        'text-secondary': '#909399',
                        'border-light': '#ebeef5',
                        'bg-page': '#f0f2f5',
                    }
                }
            }
        }
    </script>
    <style>
        /* ä»…ä¿ç•™ Tailwind æ— æ³•å®Œå…¨è¦†ç›–çš„æ ·å¼ */
        .app-header {
            background: linear-gradient(135deg, #885021 0%, #a67c52 100%);
        }
        .log-content {
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }
        /* å“åº”å¼ç»Ÿè®¡å¡ç‰‡ */
        @media (max-width: 1400px) {
            .stats-grid { grid-template-columns: repeat(3, 1fr) !important; }
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr) !important; }
            .main-grid { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 480px) {
            .stats-grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body class="bg-bg-page font-sans min-h-screen">
    <div id="app">
        <!-- é¡¶éƒ¨æ  -->
        <header class="app-header text-white py-6 mb-6 shadow-lg">
            <div class="max-w-[1400px] mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="text-center md:text-left">
                        <h1 class="text-2xl font-semibold">ğŸª å·å·çš„å°å·¥å…·</h1>
                        <p class="opacity-90 text-sm">æˆç»©ç›‘æ§ç®¡ç†é¢æ¿ï¼ˆå†…ç½‘ç‰ˆï¼‰</p>
                    </div>
                </div>
                <div class="flex gap-3">
                    <el-button @click="loadUsers" :loading="loading" round>
                        <el-icon><Refresh /></el-icon>
                        åˆ·æ–°æ•°æ®
                    </el-button>
                    <el-button type="warning" @click="triggerCheck" :loading="checking" round>
                        <el-icon><Search /></el-icon>
                        æ‰‹åŠ¨æ£€æµ‹
                    </el-button>
                    <el-button type="info" @click="showLogDialog" round>
                        <el-icon><Document /></el-icon>
                        æŸ¥çœ‹æ—¥å¿—
                    </el-button>
                </div>
            </div>
        </header>

        <div class="max-w-[1400px] mx-auto px-6 pb-6">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-grid grid grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg p-5 shadow-sm">
                    <div class="text-3xl font-semibold text-primary">[[ stats.total ]]</div>
                    <div class="text-sm text-text-secondary mt-1">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="bg-white rounded-lg p-5 shadow-sm">
                    <div class="text-3xl font-semibold text-el-success">[[ stats.enabled ]]</div>
                    <div class="text-sm text-text-secondary mt-1">ç›‘æ§ä¸­</div>
                </div>
                <div class="bg-white rounded-lg p-5 shadow-sm">
                    <div class="text-3xl font-semibold text-el-warning">[[ stats.expired ]]</div>
                    <div class="text-sm text-text-secondary mt-1">Sessionå·²è¿‡æœŸ</div>
                </div>
                <div class="bg-white rounded-lg p-5 shadow-sm">
                    <div class="text-3xl font-semibold text-el-danger">[[ stats.disabled ]]</div>
                    <div class="text-sm text-text-secondary mt-1">å·²ç¦ç”¨</div>
                </div>
                <div class="bg-white rounded-lg p-5 shadow-sm">
                    <div class="text-3xl font-semibold text-el-info">[[ stats.totalPush ]]</div>
                    <div class="text-sm text-text-secondary mt-1">æ€»æ¨é€æ¬¡æ•°</div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-grid grid grid-cols-[400px_1fr] gap-6 xl:grid-cols-[400px_1fr]">
                <!-- å¯¼å…¥é¢æ¿ -->
                <div class="bg-white rounded-lg shadow-sm h-fit">
                    <div class="px-5 py-4 border-b border-border-light font-semibold text-base text-text-primary">
                        å¯¼å…¥æ–°ç”¨æˆ·
                    </div>
                    <div class="p-5">
                        <div class="bg-gray-50 rounded-md p-3 mb-4 text-[13px] text-text-regular leading-7">
                            <strong>è¾“å…¥æ ¼å¼ï¼ˆ4è¡Œï¼‰ï¼š</strong><br>
                            ç¬¬1è¡Œï¼š<code class="bg-gray-200 px-1.5 py-0.5 rounded text-xs font-mono">å­¦å·</code><br>
                            ç¬¬2è¡Œï¼š<code class="bg-gray-200 px-1.5 py-0.5 rounded text-xs font-mono">å¯†ç </code><br>
                            ç¬¬3è¡Œï¼š<code class="bg-gray-200 px-1.5 py-0.5 rounded text-xs font-mono">é’‰é’‰Webhook URL</code><br>
                            ç¬¬4è¡Œï¼š<code class="bg-gray-200 px-1.5 py-0.5 rounded text-xs font-mono">é’‰é’‰ç­¾åå¯†é’¥</code>
                        </div>

                        <el-input
                            v-model="importText"
                            type="textarea"
                            :rows="8"
                            placeholder="202312345678
your_password
https://oapi.dingtalk.com/robot/send?access_token=xxx
SECxxxxxxxxxxxxxxx"
                            style="font-family: monospace;"
                        ></el-input>

                        <div class="flex gap-3 mt-4">
                            <el-button type="primary" @click="importUser" :loading="importing" style="flex: 1;">
                                <el-icon><Upload /></el-icon>
                                å¯¼å…¥ç”¨æˆ·
                            </el-button>
                            <el-button @click="importText = ''">
                                <el-icon><Delete /></el-icon>
                                æ¸…ç©º
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·åˆ—è¡¨é¢æ¿ -->
                <div class="bg-white rounded-lg shadow-sm">
                    <div class="px-5 py-4 border-b border-border-light font-semibold text-base text-text-primary flex justify-between items-center">
                        <span>ç”¨æˆ·åˆ—è¡¨</span>
                        <el-tag type="info">å…± [[ users.length ]] ä¸ªç”¨æˆ·</el-tag>
                    </div>

                    <!-- ç”¨æˆ·å¡ç‰‡ç½‘æ ¼ -->
                    <div class="users-grid gap-4 p-5" v-if="users.length > 0" v-loading="loading">
                        <div
                            class="border border-border-light rounded-lg p-4 transition-all duration-300 hover:shadow-lg hover:border-gray-300"
                            v-for="user in pagedUsers"
                            :key="user.user_account"
                        >
                            <div class="flex justify-between items-center mb-3">
                                <span class="text-lg font-semibold text-text-primary font-mono">
                                    [[ user.user_account ]]
                                    <span
                                        class="bg-el-info text-white px-2 py-0.5 rounded-full text-xs ml-2"
                                        v-if="user.push_count > 0"
                                    >
                                        [[ user.push_count ]] æ¬¡æ¨é€
                                    </span>
                                </span>
                                <div class="flex gap-2">
                                    <el-tag size="small" :type="user.enabled ? 'success' : 'info'">
                                        [[ user.enabled ? 'ç›‘æ§ä¸­' : 'å·²ç¦ç”¨' ]]
                                    </el-tag>
                                    <el-tag size="small" :type="user.session_expired ? 'danger' : 'success'">
                                        [[ user.session_expired ? 'Sessionè¿‡æœŸ' : 'Sessionæ­£å¸¸' ]]
                                    </el-tag>
                                </div>
                            </div>
                            <div class="text-[13px] text-text-secondary mb-3 space-y-1">
                                <p>æœ€è¿‘æ£€æŸ¥ï¼š[[ user.last_check_at ? formatTime(user.last_check_at) : 'ä»æœªæ£€æŸ¥' ]]</p>
                                <p>åˆ›å»ºæ—¶é—´ï¼š[[ formatTime(user.created_at) ]]</p>
                            </div>
                            <div class="flex gap-2 pt-3 border-t border-border-light">
                                <el-button
                                    size="small"
                                    type="primary"
                                    @click="checkUser(user.user_account)"
                                    :loading="user.checking"
                                >
                                    <el-icon><Search /></el-icon>
                                    æ£€æµ‹
                                </el-button>
                                <el-button
                                    size="small"
                                    :type="user.enabled ? 'warning' : 'success'"
                                    @click="toggleUser(user.user_account)"
                                >
                                    <el-icon><Switch /></el-icon>
                                    [[ user.enabled ? 'æš‚åœ' : 'å¯ç”¨' ]]
                                </el-button>
                                <el-button
                                    size="small"
                                    type="danger"
                                    @click="deleteUser(user.user_account)"
                                >
                                    <el-icon><Delete /></el-icon>
                                    åˆ é™¤
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div class="flex justify-center px-5 py-4 border-t border-border-light" v-if="users.length > pageSize">
                        <el-pagination
                            v-model:current-page="currentPage"
                            :page-size="pageSize"
                            :total="users.length"
                            layout="prev, pager, next, jumper"
                            @current-change="handlePageChange"
                        />
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div class="text-center py-16 px-5 text-text-secondary" v-if="!loading && users.length === 0">
                        <div class="text-6xl mb-4 opacity-50">ğŸ“­</div>
                        <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                        <p class="text-[13px] mt-2">è¯·åœ¨å·¦ä¾§å¯¼å…¥ç”¨æˆ·å¼€å§‹ç›‘æ§</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹å¯¹è¯æ¡† -->
        <el-dialog
            v-model="logDialogVisible"
            title="ç³»ç»Ÿæ—¥å¿—"
            width="80%"
            top="5vh"
            :close-on-click-modal="false"
        >
            <div class="flex gap-3 mb-3 items-center">
                <el-select v-model="selectedLog" placeholder="é€‰æ‹©æ—¥å¿—æ–‡ä»¶" style="width: 280px;" @change="loadLogContent">
                    <el-option
                        v-for="log in logFiles"
                        :key="log.name"
                        :label="log.name + ' (' + formatFileSize(log.size) + ')'"
                        :value="log.name"
                    ></el-option>
                </el-select>
                <el-input-number v-model="logLines" :min="50" :max="1000" :step="50" style="width: 120px;"></el-input-number>
                <span class="text-text-secondary text-[13px]">è¡Œ</span>
                <el-button @click="loadLogContent" :loading="logLoading">
                    <el-icon><Refresh /></el-icon>
                    åˆ·æ–°
                </el-button>
                <el-checkbox v-model="autoRefresh" @change="toggleAutoRefresh">è‡ªåŠ¨åˆ·æ–°</el-checkbox>
            </div>
            <div
                class="log-content bg-[#1e1e1e] text-[#d4d4d4] text-xs leading-relaxed p-4 rounded-md max-h-[500px] overflow-auto"
                v-loading="logLoading"
            >
                [[ logContent || 'è¯·é€‰æ‹©æ—¥å¿—æ–‡ä»¶' ]]
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { ElMessage, ElMessageBox } = ElementPlus

        const app = createApp({
            // ä¿®æ”¹ Vue åˆ†éš”ç¬¦é¿å…ä¸ Jinja2 å†²çª
            delimiters: ['[[', ']]'],
            setup() {
                const importText = ref('')
                const users = ref([])
                const loading = ref(false)
                const importing = ref(false)
                const checking = ref(false)

                // åˆ†é¡µç›¸å…³
                const currentPage = ref(1)
                const pageSize = ref(6)

                // åˆ†é¡µåçš„ç”¨æˆ·åˆ—è¡¨
                const pagedUsers = computed(() => {
                    const start = (currentPage.value - 1) * pageSize.value
                    const end = start + pageSize.value
                    return users.value.slice(start, end)
                })

                // é¡µç å˜åŒ–æ—¶çš„å¤„ç†
                const handlePageChange = (page) => {
                    currentPage.value = page
                }

                // æ—¥å¿—ç›¸å…³
                const logDialogVisible = ref(false)
                const logFiles = ref([])
                const selectedLog = ref('')
                const logContent = ref('')
                const logLoading = ref(false)
                const logLines = ref(200)
                const autoRefresh = ref(false)
                let autoRefreshTimer = null

                // æ ¼å¼åŒ–æ—¶é—´æˆ³
                const formatTime = (timestamp) => {
                    if (!timestamp) return '-'
                    const date = new Date(timestamp * 1000)
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                }

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const formatFileSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B'
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
                    return (bytes / 1024 / 1024).toFixed(1) + ' MB'
                }

                // ç»Ÿè®¡æ•°æ®
                const stats = computed(() => {
                    const total = users.value.length
                    const enabled = users.value.filter(u => u.enabled && !u.session_expired).length
                    const expired = users.value.filter(u => u.session_expired).length
                    const disabled = users.value.filter(u => !u.enabled).length
                    const totalPush = users.value.reduce((sum, u) => sum + (u.push_count || 0), 0)
                    return { total, enabled, expired, disabled, totalPush }
                })

                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                const loadUsers = async () => {
                    loading.value = true
                    try {
                        const response = await fetch('/api/users')
                        const data = await response.json()
                        if (data.success) {
                            users.value = data.users
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½å¤±è´¥: ' + error.message)
                    } finally {
                        loading.value = false
                    }
                }

                // å¯¼å…¥ç”¨æˆ·
                const importUser = async () => {
                    if (!importText.value.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·æ•°æ®')
                        return
                    }

                    importing.value = true
                    try {
                        const response = await fetch('/api/import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: importText.value })
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            importText.value = ''
                            loadUsers()
                        } else {
                            ElMessage.error(data.message)
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        importing.value = false
                    }
                }

                // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
                const toggleUser = async (userAccount) => {
                    try {
                        const response = await fetch(`/api/users/${userAccount}/toggle`, {
                            method: 'POST'
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success('çŠ¶æ€å·²æ›´æ–°')
                            loadUsers()
                        } else {
                            ElMessage.error('æ“ä½œå¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    }
                }

                // æ£€æµ‹å•ä¸ªç”¨æˆ·
                const checkUser = async (userAccount) => {
                    // è®¾ç½®è¯¥ç”¨æˆ·çš„ checking çŠ¶æ€
                    const user = users.value.find(u => u.user_account === userAccount)
                    if (user) user.checking = true

                    try {
                        const response = await fetch(`/api/users/${userAccount}/check`, {
                            method: 'POST'
                        })
                        const data = await response.json()

                        if (data.success) {
                            if (data.status === 'new_scores') {
                                ElMessage.success(data.message)
                            } else if (data.status === 'expired') {
                                ElMessage.warning(data.message)
                            } else {
                                ElMessage.info(data.message)
                            }
                            loadUsers()
                        } else {
                            ElMessage.error(data.message || 'æ£€æµ‹å¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        if (user) user.checking = false
                    }
                }

                // åˆ é™¤ç”¨æˆ·
                const deleteUser = async (userAccount) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${userAccount} å—ï¼Ÿåˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ã€‚`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®è®¤åˆ é™¤',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning',
                                confirmButtonClass: 'el-button--danger'
                            }
                        )

                        const response = await fetch(`/api/users/${userAccount}`, {
                            method: 'DELETE'
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            loadUsers()
                        } else {
                            ElMessage.error('åˆ é™¤å¤±è´¥')
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                        }
                    }
                }

                // æ‰‹åŠ¨è§¦å‘æ£€æµ‹
                const triggerCheck = async () => {
                    checking.value = true
                    try {
                        const response = await fetch('/api/check', { method: 'POST' })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            // æ£€æµ‹ååˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                            setTimeout(loadUsers, 1000)
                        } else {
                            ElMessage.error('æ£€æµ‹å¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        checking.value = false
                    }
                }

                // æ˜¾ç¤ºæ—¥å¿—å¯¹è¯æ¡†
                const showLogDialog = async () => {
                    logDialogVisible.value = true
                    await loadLogFiles()
                }

                // åŠ è½½æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
                const loadLogFiles = async () => {
                    try {
                        const response = await fetch('/api/logs')
                        const data = await response.json()
                        if (data.success) {
                            logFiles.value = data.logs
                            if (data.logs.length > 0 && !selectedLog.value) {
                                selectedLog.value = data.logs[0].name
                                await loadLogContent()
                            }
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥: ' + error.message)
                    }
                }

                // åŠ è½½æ—¥å¿—å†…å®¹
                const loadLogContent = async () => {
                    if (!selectedLog.value) return

                    logLoading.value = true
                    try {
                        const response = await fetch(`/api/logs/${selectedLog.value}?lines=${logLines.value}`)
                        const data = await response.json()
                        if (data.success) {
                            logContent.value = data.content
                        } else {
                            logContent.value = 'åŠ è½½å¤±è´¥: ' + data.message
                        }
                    } catch (error) {
                        logContent.value = 'åŠ è½½å¤±è´¥: ' + error.message
                    } finally {
                        logLoading.value = false
                    }
                }

                // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
                const toggleAutoRefresh = (val) => {
                    if (val) {
                        autoRefreshTimer = setInterval(loadLogContent, 3000)
                    } else {
                        if (autoRefreshTimer) {
                            clearInterval(autoRefreshTimer)
                            autoRefreshTimer = null
                        }
                    }
                }

                onMounted(() => {
                    loadUsers()
                })

                return {
                    importText,
                    users,
                    loading,
                    importing,
                    checking,
                    stats,
                    formatTime,
                    formatFileSize,
                    loadUsers,
                    importUser,
                    toggleUser,
                    checkUser,
                    deleteUser,
                    triggerCheck,
                    // åˆ†é¡µç›¸å…³
                    currentPage,
                    pageSize,
                    pagedUsers,
                    handlePageChange,
                    // æ—¥å¿—ç›¸å…³
                    logDialogVisible,
                    logFiles,
                    selectedLog,
                    logContent,
                    logLoading,
                    logLines,
                    autoRefresh,
                    showLogDialog,
                    loadLogContent,
                    toggleAutoRefresh
                }
            }
        })

        app.config.compilerOptions.delimiters = ['[[', ']]']
        app.use(ElementPlus)
        app.component('Refresh', ElementPlusIconsVue.Refresh)
        app.component('Search', ElementPlusIconsVue.Search)
        app.component('Upload', ElementPlusIconsVue.Upload)
        app.component('Delete', ElementPlusIconsVue.Delete)
        app.component('Switch', ElementPlusIconsVue.Switch)
        app.component('Document', ElementPlusIconsVue.Document)
        app.mount('#app')
    </script>
</body>
</html>
