<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆç»©ç›‘æ§ç®¡ç†é¢æ¿ - å·å·çš„å°å·¥å…·</title>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css">
    <link rel="stylesheet" href="https://unpkg.com/@element-plus/icons-vue">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "PingFang SC", sans-serif;
            min-height: 100vh;
        }
        .app-header {
            background: linear-gradient(135deg, #885021 0%, #a67c52 100%);
            color: white;
            padding: 24px 0;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .header-title h1 {
            font-size: 24px;
            font-weight: 600;
        }
        .header-title p {
            opacity: 0.9;
            font-size: 14px;
        }
        .header-actions {
            display: flex;
            gap: 12px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px 24px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .stat-card .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #303133;
        }
        .stat-card .stat-label {
            font-size: 14px;
            color: #909399;
            margin-top: 4px;
        }
        .stat-card.primary .stat-value { color: #885021; }
        .stat-card.success .stat-value { color: #67c23a; }
        .stat-card.warning .stat-value { color: #e6a23c; }
        .stat-card.danger .stat-value { color: #f56c6c; }
        .stat-card.info .stat-value { color: #409eff; }

        /* æ—¥å¿—æŸ¥çœ‹å™¨ */
        .log-content {
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            padding: 16px;
            border-radius: 6px;
            max-height: 500px;
            overflow: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .log-toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
            align-items: center;
        }
        .push-count-badge {
            background: #409eff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 24px;
        }

        /* å¯¼å…¥é¢æ¿ */
        .import-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }
        .panel-header {
            padding: 16px 20px;
            border-bottom: 1px solid #ebeef5;
            font-weight: 600;
            font-size: 16px;
            color: #303133;
        }
        .panel-body {
            padding: 20px;
        }
        .import-hint {
            background: #f5f7fa;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            color: #606266;
            line-height: 1.8;
        }
        .import-hint code {
            background: #e4e7ed;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        .import-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        /* ç”¨æˆ·åˆ—è¡¨é¢æ¿ */
        .users-panel {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .panel-header-with-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* ç”¨æˆ·å¡ç‰‡ç½‘æ ¼ */
        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
            padding: 20px;
        }
        .user-card {
            border: 1px solid #ebeef5;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.3s;
        }
        .user-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #dcdfe6;
        }
        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .user-account {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            font-family: monospace;
        }
        .user-card-status {
            display: flex;
            gap: 8px;
        }
        .user-card-info {
            font-size: 13px;
            color: #909399;
            margin-bottom: 12px;
        }
        .user-card-info p {
            margin: 4px 0;
        }
        .user-card-actions {
            display: flex;
            gap: 8px;
            padding-top: 12px;
            border-top: 1px solid #ebeef5;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #909399;
        }
        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* å“åº”å¼ */
        @media (max-width: 1400px) {
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .stats-row {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        @media (max-width: 768px) {
            .stats-row {
                grid-template-columns: repeat(2, 1fr);
            }
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
        }
        @media (max-width: 480px) {
            .stats-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- é¡¶éƒ¨æ  -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-title">
                    <div>
                        <h1>ğŸª å·å·çš„å°å·¥å…·</h1>
                        <p>æˆç»©ç›‘æ§ç®¡ç†é¢æ¿ï¼ˆå†…ç½‘ç‰ˆï¼‰</p>
                    </div>
                </div>
                <div class="header-actions">
                    <el-button @click="loadUsers" :loading="loading" round>
                        <el-icon><Refresh /></el-icon>
                        åˆ·æ–°æ•°æ®
                    </el-button>
                    <el-button type="warning" @click="triggerCheck" :loading="checking" round>
                        <el-icon><Search /></el-icon>
                        æ‰‹åŠ¨æ£€æµ‹
                    </el-button>
                    <el-button type="info" @click="showLogDialog" round>
                        <el-icon><Document /></el-icon>
                        æŸ¥çœ‹æ—¥å¿—
                    </el-button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-row">
                <div class="stat-card primary">
                    <div class="stat-value">[[ stats.total ]]</div>
                    <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
                </div>
                <div class="stat-card success">
                    <div class="stat-value">[[ stats.enabled ]]</div>
                    <div class="stat-label">ç›‘æ§ä¸­</div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-value">[[ stats.expired ]]</div>
                    <div class="stat-label">Sessionå·²è¿‡æœŸ</div>
                </div>
                <div class="stat-card danger">
                    <div class="stat-value">[[ stats.disabled ]]</div>
                    <div class="stat-label">å·²ç¦ç”¨</div>
                </div>
                <div class="stat-card info">
                    <div class="stat-value">[[ stats.totalPush ]]</div>
                    <div class="stat-label">æ€»æ¨é€æ¬¡æ•°</div>
                </div>
            </div>

            <!-- ä¸»å†…å®¹åŒº -->
            <div class="main-content">
                <!-- å¯¼å…¥é¢æ¿ -->
                <div class="import-panel">
                    <div class="panel-header">å¯¼å…¥æ–°ç”¨æˆ·</div>
                    <div class="panel-body">
                        <div class="import-hint">
                            <strong>è¾“å…¥æ ¼å¼ï¼ˆ4è¡Œï¼‰ï¼š</strong><br>
                            ç¬¬1è¡Œï¼š<code>å­¦å·</code><br>
                            ç¬¬2è¡Œï¼š<code>å¯†ç </code><br>
                            ç¬¬3è¡Œï¼š<code>é’‰é’‰Webhook URL</code><br>
                            ç¬¬4è¡Œï¼š<code>é’‰é’‰ç­¾åå¯†é’¥</code>
                        </div>

                        <el-input
                            v-model="importText"
                            type="textarea"
                            :rows="8"
                            placeholder="202312345678
your_password
https://oapi.dingtalk.com/robot/send?access_token=xxx
SECxxxxxxxxxxxxxxx"
                            style="font-family: monospace;"
                        ></el-input>

                        <div class="import-actions">
                            <el-button type="primary" @click="importUser" :loading="importing" style="flex: 1;">
                                <el-icon><Upload /></el-icon>
                                å¯¼å…¥ç”¨æˆ·
                            </el-button>
                            <el-button @click="importText = ''">
                                <el-icon><Delete /></el-icon>
                                æ¸…ç©º
                            </el-button>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·åˆ—è¡¨é¢æ¿ -->
                <div class="users-panel">
                    <div class="panel-header panel-header-with-actions">
                        <span>ç”¨æˆ·åˆ—è¡¨</span>
                        <el-tag type="info">å…± [[ users.length ]] ä¸ªç”¨æˆ·</el-tag>
                    </div>

                    <!-- ç”¨æˆ·å¡ç‰‡ç½‘æ ¼ -->
                    <div class="users-grid" v-if="users.length > 0" v-loading="loading">
                        <div class="user-card" v-for="user in users" :key="user.user_account">
                            <div class="user-card-header">
                                <span class="user-account">
                                    [[ user.user_account ]]
                                    <span class="push-count-badge" v-if="user.push_count > 0">
                                        [[ user.push_count ]] æ¬¡æ¨é€
                                    </span>
                                </span>
                                <div class="user-card-status">
                                    <el-tag size="small" :type="user.enabled ? 'success' : 'info'">
                                        [[ user.enabled ? 'ç›‘æ§ä¸­' : 'å·²ç¦ç”¨' ]]
                                    </el-tag>
                                    <el-tag size="small" :type="user.session_expired ? 'danger' : 'success'">
                                        [[ user.session_expired ? 'Sessionè¿‡æœŸ' : 'Sessionæ­£å¸¸' ]]
                                    </el-tag>
                                </div>
                            </div>
                            <div class="user-card-info">
                                <p>åˆ›å»ºæ—¶é—´ï¼š[[ formatTime(user.created_at) ]]</p>
                                <p>æ›´æ–°æ—¶é—´ï¼š[[ formatTime(user.updated_at) ]]</p>
                            </div>
                            <div class="user-card-actions">
                                <el-button
                                    size="small"
                                    type="primary"
                                    @click="checkUser(user.user_account)"
                                    :loading="user.checking"
                                >
                                    <el-icon><Search /></el-icon>
                                    æ£€æµ‹
                                </el-button>
                                <el-button
                                    size="small"
                                    :type="user.enabled ? 'warning' : 'success'"
                                    @click="toggleUser(user.user_account)"
                                >
                                    <el-icon><Switch /></el-icon>
                                    [[ user.enabled ? 'æš‚åœ' : 'å¯ç”¨' ]]
                                </el-button>
                                <el-button
                                    size="small"
                                    type="danger"
                                    @click="deleteUser(user.user_account)"
                                >
                                    <el-icon><Delete /></el-icon>
                                    åˆ é™¤
                                </el-button>
                            </div>
                        </div>
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div class="empty-state" v-if="!loading && users.length === 0">
                        <div class="icon">ğŸ“­</div>
                        <p>æš‚æ— ç”¨æˆ·æ•°æ®</p>
                        <p style="font-size: 13px; margin-top: 8px;">è¯·åœ¨å·¦ä¾§å¯¼å…¥ç”¨æˆ·å¼€å§‹ç›‘æ§</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æŸ¥çœ‹å¯¹è¯æ¡† -->
        <el-dialog
            v-model="logDialogVisible"
            title="ç³»ç»Ÿæ—¥å¿—"
            width="80%"
            top="5vh"
            :close-on-click-modal="false"
        >
            <div class="log-toolbar">
                <el-select v-model="selectedLog" placeholder="é€‰æ‹©æ—¥å¿—æ–‡ä»¶" style="width: 280px;" @change="loadLogContent">
                    <el-option
                        v-for="log in logFiles"
                        :key="log.name"
                        :label="log.name + ' (' + formatFileSize(log.size) + ')'"
                        :value="log.name"
                    ></el-option>
                </el-select>
                <el-input-number v-model="logLines" :min="50" :max="1000" :step="50" style="width: 120px;"></el-input-number>
                <span style="color: #909399; font-size: 13px;">è¡Œ</span>
                <el-button @click="loadLogContent" :loading="logLoading">
                    <el-icon><Refresh /></el-icon>
                    åˆ·æ–°
                </el-button>
                <el-checkbox v-model="autoRefresh" @change="toggleAutoRefresh">è‡ªåŠ¨åˆ·æ–°</el-checkbox>
            </div>
            <div class="log-content" v-loading="logLoading">[[ logContent || 'è¯·é€‰æ‹©æ—¥å¿—æ–‡ä»¶' ]]</div>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue
        const { ElMessage, ElMessageBox } = ElementPlus

        const app = createApp({
            // ä¿®æ”¹ Vue åˆ†éš”ç¬¦é¿å…ä¸ Jinja2 å†²çª
            delimiters: ['[[', ']]'],
            setup() {
                const importText = ref('')
                const users = ref([])
                const loading = ref(false)
                const importing = ref(false)
                const checking = ref(false)

                // æ—¥å¿—ç›¸å…³
                const logDialogVisible = ref(false)
                const logFiles = ref([])
                const selectedLog = ref('')
                const logContent = ref('')
                const logLoading = ref(false)
                const logLines = ref(200)
                const autoRefresh = ref(false)
                let autoRefreshTimer = null

                // æ ¼å¼åŒ–æ—¶é—´æˆ³
                const formatTime = (timestamp) => {
                    if (!timestamp) return '-'
                    const date = new Date(timestamp * 1000)
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    })
                }

                // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
                const formatFileSize = (bytes) => {
                    if (bytes < 1024) return bytes + ' B'
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
                    return (bytes / 1024 / 1024).toFixed(1) + ' MB'
                }

                // ç»Ÿè®¡æ•°æ®
                const stats = computed(() => {
                    const total = users.value.length
                    const enabled = users.value.filter(u => u.enabled && !u.session_expired).length
                    const expired = users.value.filter(u => u.session_expired).length
                    const disabled = users.value.filter(u => !u.enabled).length
                    const totalPush = users.value.reduce((sum, u) => sum + (u.push_count || 0), 0)
                    return { total, enabled, expired, disabled, totalPush }
                })

                // åŠ è½½ç”¨æˆ·åˆ—è¡¨
                const loadUsers = async () => {
                    loading.value = true
                    try {
                        const response = await fetch('/api/users')
                        const data = await response.json()
                        if (data.success) {
                            users.value = data.users
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½å¤±è´¥: ' + error.message)
                    } finally {
                        loading.value = false
                    }
                }

                // å¯¼å…¥ç”¨æˆ·
                const importUser = async () => {
                    if (!importText.value.trim()) {
                        ElMessage.warning('è¯·è¾“å…¥ç”¨æˆ·æ•°æ®')
                        return
                    }

                    importing.value = true
                    try {
                        const response = await fetch('/api/import', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ text: importText.value })
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            importText.value = ''
                            loadUsers()
                        } else {
                            ElMessage.error(data.message)
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        importing.value = false
                    }
                }

                // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
                const toggleUser = async (userAccount) => {
                    try {
                        const response = await fetch(`/api/users/${userAccount}/toggle`, {
                            method: 'POST'
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success('çŠ¶æ€å·²æ›´æ–°')
                            loadUsers()
                        } else {
                            ElMessage.error('æ“ä½œå¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    }
                }

                // æ£€æµ‹å•ä¸ªç”¨æˆ·
                const checkUser = async (userAccount) => {
                    // è®¾ç½®è¯¥ç”¨æˆ·çš„ checking çŠ¶æ€
                    const user = users.value.find(u => u.user_account === userAccount)
                    if (user) user.checking = true

                    try {
                        const response = await fetch(`/api/users/${userAccount}/check`, {
                            method: 'POST'
                        })
                        const data = await response.json()

                        if (data.success) {
                            if (data.status === 'new_scores') {
                                ElMessage.success(data.message)
                            } else if (data.status === 'expired') {
                                ElMessage.warning(data.message)
                            } else {
                                ElMessage.info(data.message)
                            }
                            loadUsers()
                        } else {
                            ElMessage.error(data.message || 'æ£€æµ‹å¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        if (user) user.checking = false
                    }
                }

                // åˆ é™¤ç”¨æˆ·
                const deleteUser = async (userAccount) => {
                    try {
                        await ElMessageBox.confirm(
                            `ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${userAccount} å—ï¼Ÿåˆ é™¤åè¯¥ç”¨æˆ·çš„æ‰€æœ‰æ•°æ®å°†è¢«æ¸…é™¤ã€‚`,
                            'ç¡®è®¤åˆ é™¤',
                            {
                                confirmButtonText: 'ç¡®è®¤åˆ é™¤',
                                cancelButtonText: 'å–æ¶ˆ',
                                type: 'warning',
                                confirmButtonClass: 'el-button--danger'
                            }
                        )

                        const response = await fetch(`/api/users/${userAccount}`, {
                            method: 'DELETE'
                        })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            loadUsers()
                        } else {
                            ElMessage.error('åˆ é™¤å¤±è´¥')
                        }
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                        }
                    }
                }

                // æ‰‹åŠ¨è§¦å‘æ£€æµ‹
                const triggerCheck = async () => {
                    checking.value = true
                    try {
                        const response = await fetch('/api/check', { method: 'POST' })
                        const data = await response.json()

                        if (data.success) {
                            ElMessage.success(data.message)
                            // æ£€æµ‹ååˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
                            setTimeout(loadUsers, 1000)
                        } else {
                            ElMessage.error('æ£€æµ‹å¤±è´¥')
                        }
                    } catch (error) {
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message)
                    } finally {
                        checking.value = false
                    }
                }

                // æ˜¾ç¤ºæ—¥å¿—å¯¹è¯æ¡†
                const showLogDialog = async () => {
                    logDialogVisible.value = true
                    await loadLogFiles()
                }

                // åŠ è½½æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
                const loadLogFiles = async () => {
                    try {
                        const response = await fetch('/api/logs')
                        const data = await response.json()
                        if (data.success) {
                            logFiles.value = data.logs
                            if (data.logs.length > 0 && !selectedLog.value) {
                                selectedLog.value = data.logs[0].name
                                await loadLogContent()
                            }
                        }
                    } catch (error) {
                        ElMessage.error('åŠ è½½æ—¥å¿—åˆ—è¡¨å¤±è´¥: ' + error.message)
                    }
                }

                // åŠ è½½æ—¥å¿—å†…å®¹
                const loadLogContent = async () => {
                    if (!selectedLog.value) return

                    logLoading.value = true
                    try {
                        const response = await fetch(`/api/logs/${selectedLog.value}?lines=${logLines.value}`)
                        const data = await response.json()
                        if (data.success) {
                            logContent.value = data.content
                        } else {
                            logContent.value = 'åŠ è½½å¤±è´¥: ' + data.message
                        }
                    } catch (error) {
                        logContent.value = 'åŠ è½½å¤±è´¥: ' + error.message
                    } finally {
                        logLoading.value = false
                    }
                }

                // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
                const toggleAutoRefresh = (val) => {
                    if (val) {
                        autoRefreshTimer = setInterval(loadLogContent, 3000)
                    } else {
                        if (autoRefreshTimer) {
                            clearInterval(autoRefreshTimer)
                            autoRefreshTimer = null
                        }
                    }
                }

                onMounted(() => {
                    loadUsers()
                })

                return {
                    importText,
                    users,
                    loading,
                    importing,
                    checking,
                    stats,
                    formatTime,
                    formatFileSize,
                    loadUsers,
                    importUser,
                    toggleUser,
                    checkUser,
                    deleteUser,
                    triggerCheck,
                    // æ—¥å¿—ç›¸å…³
                    logDialogVisible,
                    logFiles,
                    selectedLog,
                    logContent,
                    logLoading,
                    logLines,
                    autoRefresh,
                    showLogDialog,
                    loadLogContent,
                    toggleAutoRefresh
                }
            }
        })

        app.config.compilerOptions.delimiters = ['[[', ']]']
        app.use(ElementPlus)
        app.component('Refresh', ElementPlusIconsVue.Refresh)
        app.component('Search', ElementPlusIconsVue.Search)
        app.component('Upload', ElementPlusIconsVue.Upload)
        app.component('Delete', ElementPlusIconsVue.Delete)
        app.component('Switch', ElementPlusIconsVue.Switch)
        app.component('Document', ElementPlusIconsVue.Document)
        app.mount('#app')
    </script>
</body>
</html>
